{% extends "./layouts/shell.html" %}

{% block head %}
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/docx-preview@0.3.7/dist/docx-preview.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
{% endblock %}

{% block content %}
  <div class="container mx-auto px-4 py-12">
    <div class="grid grid-cols-1 gap-8 lg:grid-cols-3">
      <div class="lg:col-span-2">
        <div class="mx-auto w-full overflow-hidden rounded-lg border border-neutral-200 bg-white shadow-sm dark:border-neutral-700 dark:bg-neutral-800">
          <div class="p-8 md:p-12">
            <div id="project-details">
              <h1 class="mb-4 text-4xl font-extrabold md:text-5xl">{{ project.name }}</h1>
              <div class="mb-6 border-b border-gray-200 pb-4 dark:border-gray-700">
                <p class="text-md text-gray-500 dark:text-gray-300">
                  <span class="me-5">
                    Created by:
                    <span class="font-medium text-blue-600 dark:text-blue-400">
                      {% if project.role == 1 %}
                        <a href="/business/{{ project.user_id }}" class="underline">{{ project.business_name }}</a>
                      {% else %}
                        {{ project.business_name }}
                      {% endif %}
                    </span>
                  </span>
                  {% if project.status == 4 %}
                    <span class="me-2 rounded bg-purple-100 px-2.5 py-0.5 text-sm font-medium text-purple-800 dark:bg-purple-900 dark:text-purple-300">Finished</span>
                  {% elif project.status == 3 %}
                    <span class="me-2 rounded bg-blue-100 px-2.5 py-0.5 text-sm font-medium text-blue-800 dark:bg-blue-900 dark:text-blue-300">Taken</span>
                  {% elif project.status == 2 %}
                    <span class="me-2 rounded bg-green-100 px-2.5 py-0.5 text-sm font-medium text-green-800 dark:bg-green-900 dark:text-green-300"> Approved</span>
                  {% elif project.status == 1 %}
                    <span class="me-2 rounded bg-yellow-100 px-2.5 py-0.5 text-sm font-medium text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300">Pending Approval</span>
                  {% else %}
                    <span class="me-2 rounded bg-red-100 px-2.5 py-0.5 text-sm font-medium text-red-800 dark:bg-red-900 dark:text-red-300"> Submitted</span>
                  {% endif %}
                </p>
              </div>
              <div class="max-w-none text-lg">
                <p class="whitespace-pre-line">{{ project.description }}</p>
              </div>
              <div class="mt-6 space-y-2">
                {% if project.project_link %}<p><strong>Project Link:</strong> <a href="{{ project.project_link }}" target="_blank" class="text-blue-500 hover:underline">{{ project.project_link }}</a></p>{% endif %}
                {% if project.github_link %}<p><strong>GitHub Link:</strong> <a href="{{ project.github_link }}" target="_blank" class="text-blue-500 hover:underline">{{ project.github_link }}</a></p>{% endif %}

                {% if project.attachment_path %}
                  <p><strong>Attachment(s):</strong></p>
                  <div class="flex flex-wrap items-center gap-4">
                    {% set paths = project.attachment_path.split(';') %}
                    {% for path in paths %}
                      {% if path %}
                        {% set original_filename = path.split('/')[-1] %}
                        {% set extension = original_filename.split('.')[-1].lower() %}

                        {% if extension in ['jpg', 'jpeg', 'png', 'gif', 'webp'] %}
                          <a href="{{ path }}" target="_blank">
                            <img src="{{ path }}" alt="Project Attachment" class="mt-2 h-24 w-24 rounded-lg object-cover shadow-md" />
                          </a>
                        {% elif extension == 'docx' %}
                          <button type="button" class="text-blue-500 hover:underline" popovertarget="file-viewer-popover" onclick="viewDocx('{{ path }}', '{{ original_filename }}')">View ({{ original_filename }})</button>
                        {% elif extension in ['xlsx', 'xls'] %}
                          <button type="button" class="text-blue-500 hover:underline" popovertarget="file-viewer-popover" onclick="viewExcel('{{ path }}', '{{ original_filename }}')">View ({{ original_filename }})</button>
                        {% else %}
                          <a href="{{ path }}" target="_blank" class="text-blue-500 hover:underline"> View ({{ original_filename }}) </a>
                        {% endif %}

                        {% if session.user_id == project.user_id or (session.get('role') == 0 and project.status in [2, 3]) %}
                          <button type="button" class="text-xs text-gray-500 hover:text-blue-500" popovertarget="rename-popover" onclick="openRenamePopover('{{ path }}', '{{ original_filename }}')">(Edit Name)</button>
                        {% endif %}
                      {% endif %}
                    {% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>

            <div class="mt-8 border-t border-gray-200 pt-6 dark:border-gray-700">
              <h3 class="mb-4 text-2xl font-semibold">Comments</h3>

              {% if can_comment %}
                <form action="/project/{{ project.id }}/comment" method="POST" enctype="multipart/form-data" class="mb-6">
                  <label for="comment" class="mb-2 block text-sm font-medium">Add a comment</label>
                  <textarea name="comment" id="comment" class="field-sizing-content min-h-[80px] w-full rounded-lg border border-neutral-300 p-2 placeholder:text-neutral-500 dark:border-neutral-700" placeholder="Write your comment..."></textarea>

                  <label for="attachment" class="mt-2 mb-2 block text-sm font-medium">Attach File(s) (Optional)</label>
                  <input type="file" name="attachment" id="attachment" multiple class="w-full rounded-lg border border-neutral-300 p-2 file:mr-4 file:rounded-md file:border-0 file:bg-gray-200 file:px-4 file:py-2 file:text-sm file:font-semibold placeholder:text-neutral-500 hover:file:bg-gray-300 dark:border-neutral-700 dark:file:bg-gray-700 dark:file:text-gray-200 dark:hover:file:bg-gray-600" />

                  <button type="submit" class="btn-primary mt-4">Submit Comment</button>
                </form>
              {% endif %}

              <div class="space-y-4">
                {% if comments %}
                  {% for comment in comments %}
                    <div class="rounded-lg bg-gray-100 p-4 dark:bg-gray-800">
                      <div class="mb-2 flex items-center justify-between">
                        <span class="font-semibold">
                          {{ comment.name }}
                          {% if comment.role == 0 %}
                            <span class="text-xs font-normal text-red-500">(Instructor)</span>
                          {% elif comment.role == 1 %}
                            <span class="text-xs font-normal text-blue-500">(Business)</span>
                          {% elif comment.role == 3 %}
                            <span class="text-xs font-normal text-green-500">(Student)</span>
                          {% endif %}
                        </span>

                        <div class="flex items-center gap-3">
                          <span class="text-xs text-gray-500 dark:text-gray-400"> {{ comment.created_at.strftime('%b %d, %Y at %I:%M %p') }} </span>

                          {% if session.user_id == comment.user_id or (session.get('role') == 0 and (comment.role == 1 or comment.role == 3)) %}
                            <form action="/project/{{ project.id }}/comment/{{ comment.id }}/delete" method="POST" onsubmit="return confirm('Are you sure you want to delete this comment?');">
                              <button type="submit" class="text-lg font-bold text-gray-400 hover:text-red-500" title="Delete comment">&times;</button>
                            </form>
                          {% endif %}
                        </div>
                      </div>
                      <p class="whitespace-pre-line">{{ comment.comment }}</p>

                      {% if comment.attachment_path %}
                        <div class="mt-2 flex flex-wrap gap-4">
                          {% set paths = comment.attachment_path.split(';') %}
                          {% for path in paths %}
                            {% if path %}
                              {% set original_filename = path.split('/')[-1] %}
                              {% set extension = original_filename.split('.')[-1].lower() %}

                              {% if extension in ['jpg', 'jpeg', 'png', 'gif', 'webp'] %}
                                <a href="{{ path }}" target="_blank">
                                  <img src="{{ path }}" alt="Comment Attachment" class="mt-2 h-20 w-20 rounded-lg object-cover shadow-md" />
                                </a>
                              {% elif extension == 'docx' %}
                                <button type="button" class="text-sm text-blue-500 hover:underline" popovertarget="file-viewer-popover" onclick="viewDocx('{{ path }}', '{{ original_filename }}')">View ({{ original_filename }})</button>
                              {% elif extension in ['xlsx', 'xls'] %}
                                <button type="button" class="text-sm text-blue-500 hover:underline" popovertarget="file-viewer-popover" onclick="viewExcel('{{ path }}', '{{ original_filename }}')">View ({{ original_filename }})</button>
                              {% else %}
                                <a href="{{ path }}" target="_blank" class="text-sm text-blue-500 hover:underline"> View ({{ original_filename }}) </a>
                              {% endif %}
                            {% endif %}
                          {% endfor %}
                        </div>
                      {% endif %}
                    </div>
                  {% endfor %}
                {% else %}
                  <p class="text-gray-500">No comments yet.</p>
                {% endif %}
              </div>
            </div>

            {% if teams %}
              <div class="mt-8 border-t border-gray-200 pt-6 dark:border-gray-700">
                <h3 class="mb-4 text-2xl font-semibold">Assigned Teams</h3>
                <div class="space-y-4">
                  {% for team in teams %}
                    <div class="rounded-lg bg-gray-100 p-4 dark:bg-gray-800">
                      <h4 class="font-bold">{{ team.name }}</h4>
                      <ul class="mt-2 list-inside list-disc">
                        {% for member in team.members %}<li>{{ member.email }}</li>{% endfor %}
                      </ul>
                    </div>
                  {% endfor %}
                </div>
              </div>
            {% endif %}

            {% if can_edit_links %}
              <div class="mt-8 border-t border-gray-200 pt-6 dark:border-gray-700">
                <h3 class="mb-4 text-lg font-semibold">Project Links</h3>
                <form action="/project/{{ project.id }}/links" method="POST" id="links-form" class="hidden space-y-4">
                  <div><label for="project_link" class="mb-2 block text-sm font-medium">Project URL</label><input type="url" name="project_link" id="project_link" value="{{ project.project_link or '' }}" class="text w-full rounded-lg border border-neutral-300 p-2 placeholder:text-neutral-500 dark:border-neutral-700" placeholder="https://example.com/my-project" /></div>
                  <div><label for="github_link" class="mb-2 block text-sm font-medium">GitHub URL</label><input type="url" name="github_link" id="github_link" value="{{ project.github_link or '' }}" class="text w-full rounded-lg border border-neutral-300 p-2 placeholder:text-neutral-500 dark:border-neutral-700" placeholder="https://github.com/user/repo" /></div>
                  <div class="flex items-center gap-4"><button type="submit" class="btn-primary text">Save Links</button><button type="button" onclick="toggleLinksForm()" class="btn-secondary text">Cancel</button></div>
                </form>
                <div class="flex items-center gap-4" id="links-control-buttons"><button onclick="toggleLinksForm()" class="btn-secondary">Edit Links</button></div>
              </div>
            {% endif %}

            {% if session.user_id == project.user_id %}
              <div class="mt-8 border-t border-gray-200 pt-6 dark:border-gray-700">
                <h3 class="mb-4 text-lg font-semibold">Owner Controls</h3>
                <form action="/project/{{ project.id }}/update" method="POST" id="edit-form" class="mb-6 hidden space-y-4" enctype="multipart/form-data">
                  <div><label for="name" class="mb-2 block text-sm font-medium">Project Name</label><input type="text" name="name" id="name" value="{{ project.name }}" class="text w-full rounded-lg border border-neutral-300 p-2 placeholder:text-neutral-500 dark:border-neutral-700" required /></div>
                  <div><label for="description" class="mb-2 block text-sm font-medium">Description</label><textarea name="description" id="description" class="field-sizing-content min-h-[100px] w-full rounded-lg border border-neutral-300 p-2 placeholder:text-neutral-500 dark:border-neutral-700" required>{{ project.description }}</textarea></div>

                  <div>
                    <label class="mb-2 block text-sm font-medium">Manage Attachments</label>
                    {% if project.attachment_path %}
                      <div class="mb-2 text-sm">
                        <p>Current Files:</p>
                        <div class="space-y-2 rounded-md border p-2 dark:border-gray-600">
                          {% set paths = project.attachment_path.split(';') %}
                          {% for path in paths %}
                            {% if path %}
                              {% set original_filename = path.split('/')[-1] %}
                              {% set extension = original_filename.split('.')[-1].lower() %}

                              <div class="flex items-center justify-between">
                                <label for="del-{{ loop.index }}" class="flex items-center gap-2">
                                  <input type="checkbox" name="files_to_delete" value="{{ path }}" id="del-{{ loop.index }}" class="rounded text-red-500 focus:ring-red-400" />
                                  <span class="text-red-500">Delete</span>
                                </label>

                                <div class="flex items-center gap-2">
                                  {% if extension in ['jpg', 'jpeg', 'png', 'gif', 'webp'] %}
                                    <a href="{{ path }}" target="_blank" class="text-blue-500 hover:underline">{{ original_filename }} (Image)</a>
                                  {% elif extension == 'docx' %}
                                    <button type="button" class="text-blue-500 hover:underline" popovertarget="file-viewer-popover" onclick="viewDocx('{{ path }}', '{{ original_filename }}')">{{ original_filename }}</button>
                                  {% elif extension in ['xlsx', 'xls'] %}
                                    <button type="button" class="text-blue-500 hover:underline" popovertarget="file-viewer-popover" onclick="viewExcel('{{ path }}', '{{ original_filename }}')">{{ original_filename }}</button>
                                  {% else %}
                                    <a href="{{ path }}" target="_blank" class="text-blue-500 hover:underline">{{ original_filename }}</a>
                                  {% endif %}

                                  <button type="button" class="text-xs text-gray-500 hover:text-blue-500" popovertarget="rename-popover" onclick="openRenamePopover('{{ path }}', '{{ original_filename }}')">(Edit)</button>
                                </div>
                              </div>
                            {% endif %}
                          {% endfor %}
                        </div>
                      </div>
                    {% endif %}

                    <label for="attachment" class="mt-4 mb-2 block text-sm font-medium">Add New Attachment(s)</label>
                    <input type="file" name="attachment" id="attachment" multiple class="w-full rounded-lg border border-neutral-300 p-2 file:mr-4 file:rounded-md file:border-0 file:bg-gray-200 file:px-4 file:py-2 file:text-sm file:font-semibold placeholder:text-neutral-500 hover:file:bg-gray-300 dark:border-neutral-700 dark:file:bg-gray-700 dark:file:text-gray-200 dark:hover:file:bg-gray-600" />
                    <p class="mt-1 text-xs text-gray-500">Uploading new files will add them to the project. Use the checkboxes to delete old ones.</p>
                  </div>
                  <div class="flex items-center gap-4"><button type="submit" class="btn-primary text">Save Changes</button><button type="button" onclick="toggleEditForm()" class="btn-secondary text">Cancel</button></div>
                </form>
                <div class="flex items-center gap-4" id="control-buttons">
                  <button onclick="toggleEditForm()" class="btn-secondary">Edit Details</button>
                  <form action="/project/{{ project.id }}/delete" method="POST" onsubmit="return confirm('Are you sure?');"><button type="submit" class="btn-danger text">Delete Project</button></form>
                </div>
              </div>
            {% endif %}

            {% if session.get('role') == 0 %}
              <div class="mt-8 border-t border-gray-200 pt-6 dark:border-gray-700">
                <h3 class="mb-4 text-lg font-semibold text-red-600 dark:text-red-400">Instructor Controls</h3>
                <form action="/project/{{ project.id }}/approve" method="POST" class="space-y-2 md:flex md:gap-2 md:space-y-0">
                  <button type="submit" name="new_status" value="4" class="w-full rounded-lg bg-purple-600 px-5 py-2.5 text-center text-sm font-medium text-white hover:bg-purple-700 disabled:cursor-not-allowed disabled:opacity-50" {% if project.status < 3 %}disabled{% endif %} title="{% if project.status < 3 %}Project must be 'Taken' to be marked 'Finished'{% endif %}">Mark as Finished</button>
                  <button type="submit" name="new_status" value="2" class="w-full rounded-lg bg-green-600 px-5 py-2.5 text-center text-sm font-medium text-white hover:bg-green-700 disabled:cursor-not-allowed disabled:opacity-50" {% if project.status == 2 %}disabled{% endif %}>Approve Project</button>
                  <button type="submit" name="new_status" value="1" class="w-full rounded-lg bg-yellow-500 px-5 py-2.5 text-center text-sm font-medium text-white hover:bg-yellow-600 disabled:cursor-not-allowed disabled:opacity-50" {% if is_pending_by_current_instructor %}disabled{% endif %}>Set to Pending</button>
                  <button type="submit" name="new_status" value="0" class="w-full rounded-lg bg-red-600 px-5 py-2.5 text-center text-sm font-medium text-white hover:bg-red-700 disabled:cursor-not-allowed disabled:opacity-50" {% if project.status == 0 %}disabled{% endif %}>Unlist Project</button>
                </form>
              </div>

              {% if project.status in [2, 3] and session.user_id != project.user_id %}
                <div class="mt-8 border-t border-gray-200 pt-6 dark:border-gray-700">
                  <h3 class="mb-4 text-lg font-semibold">Instructor File Management</h3>
                  <form action="/project/{{ project.id }}/instructor-manage-files" method="POST" id="instructor-file-form" class="mb-6 hidden space-y-4" enctype="multipart/form-data">
                    <div>
                      <label class="mb-2 block text-sm font-medium">Manage Attachments</label>
                      {% if project.attachment_path %}
                        <div class="mb-2 text-sm">
                          <p>Current Files:</p>
                          <div class="space-y-2 rounded-md border p-2 dark:border-gray-600">
                            {% set paths = project.attachment_path.split(';') %}
                            {% for path in paths %}
                              {% if path %}
                                {% set original_filename = path.split('/')[-1] %}
                                {% set extension = original_filename.split('.')[-1].lower() %}

                                <div class="flex items-center justify-between">
                                  <label for="inst-del-{{ loop.index }}" class="flex items-center gap-2">
                                    <input type="checkbox" name="files_to_delete" value="{{ path }}" id="inst-del-{{ loop.index }}" class="rounded text-red-500 focus:ring-red-400" />
                                    <span class="text-red-500">Delete</span>
                                  </label>

                                  <div class="flex items-center gap-2">
                                    {% if extension in ['jpg', 'jpeg', 'png', 'gif', 'webp'] %}
                                      <a href="{{ path }}" target="_blank" class="text-blue-500 hover:underline">{{ original_filename }} (Image)</a>
                                    {% elif extension == 'docx' %}
                                      <button type="button" class="text-blue-500 hover:underline" popovertarget="file-viewer-popover" onclick="viewDocx('{{ path }}', '{{ original_filename }}')">{{ original_filename }}</button>
                                    {% elif extension in ['xlsx', 'xls'] %}
                                      <button type="button" class="text-blue-500 hover:underline" popovertarget="file-viewer-popover" onclick="viewExcel('{{ path }}', '{{ original_filename }}')">{{ original_filename }}</button>
                                    {% else %}
                                      <a href="{{ path }}" target="_blank" class="text-blue-500 hover:underline">{{ original_filename }}</a>
                                    {% endif %}

                                    <button type="button" class="text-xs text-gray-500 hover:text-blue-500" popovertarget="rename-popover" onclick="openRenamePopover('{{ path }}', '{{ original_filename }}')">(Edit)</button>
                                  </div>
                                </div>
                              {% endif %}
                            {% endfor %}
                          </div>
                        </div>
                      {% endif %}
                      <label for="inst-attachment" class="mt-4 mb-2 block text-sm font-medium">Add New Attachment(s)</label>
                      <input type="file" name="attachment" id="inst-attachment" multiple class="w-full rounded-lg border border-neutral-300 p-2 file:mr-4 file:rounded-md file:border-0 file:bg-gray-200 file:px-4 file:py-2 file:text-sm file:font-semibold placeholder:text-neutral-500 hover:file:bg-gray-300 dark:border-neutral-700 dark:file:bg-gray-700 dark:file:text-gray-200 dark:hover:file:bg-gray-600" />
                      <p class="mt-1 text-xs text-gray-500">Uploading new files will add them to the project. Use the checkboxes to delete old ones.</p>
                    </div>
                    <div class="flex items-center gap-4">
                      <button type="submit" class="btn-primary text">Save File Changes</button>
                      <button type="button" onclick="toggleInstructorFileForm()" class="btn-secondary text">Cancel</button>
                    </div>
                  </form>
                  <div class="flex items-center gap-4" id="instructor-file-controls">
                    <button onclick="toggleInstructorFileForm()" class="btn-secondary">Manage Project Files</button>
                  </div>
                </div>
              {% endif %}
            {% endif %}
          </div>
        </div>
      </div>

      <div class="lg:col-span-1">
        {% if can_chat %}
          <div class="flex h-[70vh] flex-col rounded-lg border border-neutral-200 bg-white p-4 shadow-sm dark:border-neutral-700 dark:bg-neutral-800">
            <h3 class="mb-4 border-b pb-2 text-center text-xl font-semibold dark:border-gray-600">Project Chat</h3>
            <div id="chat-messages" class="flex-grow space-y-4 overflow-y-auto pr-2">
              {% for msg in chat_history %}
                <div id="message-{{ msg.message_id }}" class="{% if msg.email == session.email %}items-end{% else %}items-start{% endif %} flex flex-col">
                  <div class="flex items-center gap-2">
                    {% if msg.email == session.email %}
                      <button class="delete-btn text-xs text-gray-400 hover:text-red-500" data-message-id="{{ msg.message_id }}">&times;</button>
                    {% endif %}
                    <div class="text-xs text-gray-500 dark:text-gray-400">{{ msg.email }} <span class="ml-2 text-gray-400">{{ msg.timestamp.strftime("%b %d, %I:%M %p") }}</span></div>
                  </div>
                  <div class="message-body {% if msg.email == session.email %}bg-blue-600 text-white{% else %}bg-gray-100 dark:bg-gray-700{% endif %} max-w-xs rounded-lg p-2 break-words">
                    {{ msg.message_text }}

                    {% if msg.attachment_path %}
                      {% set original_filename = msg.attachment_path.split('/')[-1] %}
                      {% set extension = original_filename.split('.')[-1].lower() %}

                      {% if extension in ['jpg', 'jpeg', 'png', 'gif', 'webp'] %}
                        <a href="{{ msg.attachment_path }}" target="_blank">
                          <img src="{{ msg.attachment_path }}" alt="Chat Attachment" class="mt-2 h-auto max-w-[200px] rounded-lg" />
                        </a>
                      {% elif extension == 'docx' %}
                        {% if msg.email == session.email %}
                          <button type="button" class="mt-1 block text-sm font-bold text-white underline dark:text-blue-300" popovertarget="file-viewer-popover" onclick="viewDocx('{{ msg.attachment_path }}', '{{ original_filename }}')">View ({{ original_filename }})</button>
                        {% else %}
                          <button type="button" class="mt-1 block text-sm font-bold text-blue-500 underline dark:text-blue-400" popovertarget="file-viewer-popover" onclick="viewDocx('{{ msg.attachment_path }}', '{{ original_filename }}')">View ({{ original_filename }})</button>
                        {% endif %}
                      {% elif extension in ['xlsx', 'xls'] %}
                        {% if msg.email == session.email %}
                          <button type="button" class="mt-1 block text-sm font-bold text-white underline dark:text-blue-300" popovertarget="file-viewer-popover" onclick="viewExcel('{{ msg.attachment_path }}', '{{ original_filename }}')">View ({{ original_filename }})</button>
                        {% else %}
                          <button type="button" class="mt-1 block text-sm font-bold text-blue-500 underline dark:text-blue-400" popovertarget="file-viewer-popover" onclick="viewExcel('{{ msg.attachment_path }}', '{{ original_filename }}')">View ({{ original_filename }})</button>
                        {% endif %}
                      {% else %}
                        {% if msg.email == session.email %}
                          <a href="{{ msg.attachment_path }}" target="_blank" class="mt-1 block text-sm font-bold text-white underline dark:text-blue-300"> View ({{ original_filename }}) </a>
                        {% else %}
                          <a href="{{ msg.attachment_path }}" target="_blank" class="mt-1 block text-sm font-bold text-blue-500 underline dark:text-blue-400"> View ({{ original_filename }}) </a>
                        {% endif %}
                      {% endif %}
                    {% endif %}
                  </div>
                </div>
              {% endfor %}
            </div>
            <div class="mt-4 border-t pt-4 dark:border-gray-600">
              <form id="chat-form" class="flex flex-col items-center gap-2">
                <input type="text" id="message-input" placeholder="Type a message..." class="w-full rounded-lg border border-neutral-300 p-2 placeholder:text-neutral-500 dark:border-neutral-700" autocomplete="off" />
                <input type="file" id="chat-file-input" class="w-full rounded-lg border border-neutral-300 p-2 file:mr-4 file:rounded-md file:border-0 file:bg-gray-200 file:px-4 file:py-2 file:text-sm file:font-semibold placeholder:text-neutral-500 hover:file:bg-gray-300 dark:border-neutral-700 dark:file:bg-gray-700 dark:file:text-gray-200 dark:hover:file:bg-gray-600" />
                <button type="submit" class="btn-primary mt-2 w-full flex-shrink-0 rounded-lg bg-blue-600 p-2 text-white">Send</button>
              </form>
            </div>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <div id="file-viewer-popover" popover class="max-w-4xl rounded-lg border border-neutral-200 bg-white p-0 shadow-sm backdrop:bg-black/50 dark:border-neutral-700 dark:bg-neutral-800">
    <div class="flex flex-wrap items-center justify-between gap-4 border-b p-4 dark:border-gray-700">
      <h3 id="file-viewer-title" class="text-2xl font-semibold">File Viewer</h3>
      <div class="flex items-center gap-4">
        <a id="file-viewer-download" href="#" download="file" class="btn-secondary text-sm">Download</a>
        <button popovertarget="file-viewer-popover" popovertargetaction="hide" class="text-2xl text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">&times;</button>
      </div>
    </div>
    <div id="file-viewer-content" class="overflow-auto p-6" style="max-height: 80vh;"></div>
  </div>

  <div id="rename-popover" popover class="max-w-lg rounded-lg border border-neutral-200 bg-white p-0 shadow-sm backdrop:bg-black/50 dark:border-neutral-700 dark:bg-neutral-800">
    <div class="flex items-center justify-between border-b p-4 dark:border-gray-700">
      <h3 class="text-2xl font-semibold">Rename File</h3>
      <button popovertarget="rename-popover" popovertargetaction="hide" class="text-2xl text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">&times;</button>
    </div>
    <form id="rename-form" action="" method="POST" class="space-y-4 p-6">
      <input type="hidden" name="old_path" id="rename-old-path" />
      <div>
        <label for="rename-new-name" class="mb-2 block text-sm font-medium">New Filename</label>
        <input type="text" name="new_filename" id="rename-new-name" class="text w-full rounded-lg border border-neutral-300 p-2 placeholder:text-neutral-500 dark:border-neutral-700" required />
        <p class="mt-1 text-xs text-gray-500">The file extension will be preserved.</p>
      </div>
      <button type="submit" class="btn-primary w-full">Rename</button>
    </form>
  </div>

  <script>
    function toggleEditForm() {
      document.getElementById("edit-form").classList.toggle("hidden");
      document.getElementById("control-buttons").classList.toggle("hidden");
    }
    function toggleLinksForm() {
      document.getElementById("links-form").classList.toggle("hidden");
      document.getElementById("links-control-buttons").classList.toggle("hidden");
    }

    function toggleInstructorFileForm() {
      document.getElementById("instructor-file-form").classList.toggle("hidden");
      document.getElementById("instructor-file-controls").classList.toggle("hidden");
    }

    const rootUrl = "{{ request.url_root.rstrip('/') }}";
    const titleEl = document.getElementById("file-viewer-title");
    const contentEl = document.getElementById("file-viewer-content");
    const downloadBtn = document.getElementById("file-viewer-download");

    // NEW: JS function for the rename popover
    function openRenamePopover(oldPath, oldFilename) {
      const form = document.getElementById("rename-form");
      const oldPathInput = document.getElementById("rename-old-path");
      const newNameInput = document.getElementById("rename-new-name");

      // Set the form's action URL dynamically
      form.action = `/project/{{ project.id }}/file/rename`;

      // Pre-fill the form fields
      oldPathInput.value = oldPath;
      newNameInput.value = oldFilename;
    }

    async function viewDocx(url, filename) {
      const fullUrl = rootUrl + url;

      titleEl.textContent = filename;
      contentEl.innerHTML = '<p class="text">Loading document...</p>';
      contentEl.className = "p-6 overflow-y-auto docx-preview-wrapper";

      downloadBtn.href = fullUrl;
      downloadBtn.setAttribute("download", filename);

      try {
        const response = await fetch(fullUrl);
        const blob = await response.blob();

        contentEl.innerHTML = "";

        window.docx.renderAsync(blob, contentEl);
      } catch (error) {
        console.error("Error rendering docx:", error);
        contentEl.innerHTML = '<p class="text-red-500">Could not load document.</p>';
      }
    }

    async function viewExcel(url, filename) {
      const fullUrl = rootUrl + url;

      titleEl.textContent = filename;
      contentEl.innerHTML = '<p class="text">Loading workbook...</p>';
      contentEl.className = "p-6 overflow-auto";

      downloadBtn.href = fullUrl;
      downloadBtn.setAttribute("download", filename);

      try {
        const response = await fetch(fullUrl);
        const arrayBuffer = await response.arrayBuffer();
        const data = new Uint8Array(arrayBuffer);

        const workbook = XLSX.read(data, { type: "array" });
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];

        const htmlTable = XLSX.utils.sheet_to_html(worksheet);

        contentEl.innerHTML = htmlTable;

        const table = contentEl.querySelector("table");
        if (table) {
          table.className = "w-full text-sm text-left text-gray-500 dark:text-gray-400";
          table.querySelectorAll("thead").forEach((th) => (th.className = "text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400"));
          table.querySelectorAll("th, td").forEach((cell) => (cell.className = "px-4 py-2 border dark:border-gray-600"));
        }
      } catch (error) {
        console.error("Error rendering excel:", error);
        contentEl.innerHTML = '<p class="text-red-500">Could not load workbook.</p>';
      }
    }
  </script>

  {% if can_chat %}
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const projectId = "{{ project.id }}";
        const currentUserEmail = "{{ session.email }}";
        const messagesContainer = document.getElementById("chat-messages");
        const chatForm = document.getElementById("chat-form");
        const messageInput = document.getElementById("message-input");
        const fileInput = document.getElementById("chat-file-input");
        const socket = io();

        const rootUrl = "{{ request.url_root.rstrip('/') }}";

        if (messagesContainer) {
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        socket.on("connect", () => socket.emit("join", { project_id: projectId }));

        socket.on("message_broadcast", (data) => {
          const isCurrentUser = data.email === currentUserEmail;
          const msgContainer = document.createElement("div");
          msgContainer.id = `message-${data.message_id}`;
          msgContainer.className = `flex flex-col ${isCurrentUser ? "items-end" : "items-start"}`;

          let deleteBtnHtml = isCurrentUser ? `<button class="delete-btn text-xs text-gray-400 hover:text-red-500" data-message-id="${data.message_id}">&times;</button>` : "";

          const infoDiv = document.createElement("div");
          infoDiv.className = "flex items-center gap-2";
          infoDiv.innerHTML = `${deleteBtnHtml}<div class="text-xs text-gray-500 dark:text-gray-400">${data.email} <span class="ml-2 text-gray-400">${data.timestamp}</span></div>`;

          const messageBody = document.createElement("div");
          messageBody.className = `message-body rounded-lg p-2 max-w-xs break-words ${isCurrentUser ? "bg-blue-600 text-white" : "bg-gray-100 dark:bg-gray-700"}`;
          messageBody.textContent = data.message;

          if (data.attachment_path) {
            // UPDATED: Removed the split logic to get the real filename
            const original_filename = data.attachment_path.split("/").pop();
            const extension = original_filename.split(".").pop().toLowerCase();

            if (["jpg", "jpeg", "png", "gif", "webp"].includes(extension)) {
              const attachmentLink = document.createElement("a");
              attachmentLink.href = data.attachment_path;
              attachmentLink.target = "_blank";
              const img = document.createElement("img");
              img.src = data.attachment_path;
              img.alt = "Chat Attachment";
              img.className = "mt-2 max-w-[200px] h-auto rounded-lg";
              attachmentLink.appendChild(img);
              messageBody.appendChild(attachmentLink);
            } else if (extension === "docx") {
              const viewButton = document.createElement("button");
              viewButton.type = "button";
              viewButton.setAttribute("popovertarget", "file-viewer-popover");
              viewButton.onclick = () => viewDocx(data.attachment_path, original_filename);

              if (isCurrentUser) {
                viewButton.className = "mt-1 block text-sm font-bold text-white underline dark:text-blue-300";
              } else {
                viewButton.className = "mt-1 block text-sm font-bold text-blue-500 underline dark:text-blue-400";
              }
              viewButton.textContent = `View (${original_filename})`;
              messageBody.appendChild(viewButton);
            } else if (extension === "xlsx" || extension === "xls") {
              const viewButton = document.createElement("button");
              viewButton.type = "button";
              viewButton.setAttribute("popovertarget", "file-viewer-popover");
              viewButton.onclick = () => viewExcel(data.attachment_path, original_filename);

              if (isCurrentUser) {
                viewButton.className = "mt-1 block text-sm font-bold text-white underline dark:text-blue-300";
              } else {
                viewButton.className = "mt-1 block text-sm font-bold text-blue-500 underline dark:text-blue-400";
              }
              viewButton.textContent = `View (${original_filename})`;
              messageBody.appendChild(viewButton);
            } else {
              const attachmentLink = document.createElement("a");
              attachmentLink.href = data.attachment_path;
              attachmentLink.target = "_blank";

              if (isCurrentUser) {
                attachmentLink.className = "mt-1 block text-sm font-bold text-white underline dark:text-blue-300";
              } else {
                attachmentLink.className = "mt-1 block text-sm font-bold text-blue-500 underline dark:text-blue-400";
              }
              attachmentLink.textContent = `View (${original_filename})`;
              messageBody.appendChild(attachmentLink);
            }
          }

          msgContainer.appendChild(infoDiv);
          msgContainer.appendChild(messageBody);
          messagesContainer.appendChild(msgContainer);
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        });

        socket.on("message_deleted", (data) => {
          const msgElement = document.getElementById(`message-${data.message_id}`);
          if (msgElement) {
            msgElement.remove();
          }
        });

        messagesContainer.addEventListener("click", (e) => {
          if (e.target.classList.contains("delete-btn")) {
            const messageId = e.target.dataset.messageId;
            if (confirm("Are you sure you want to delete this message?")) {
              socket.emit("delete_message", { message_id: messageId });
            }
          }
        });

        chatForm.addEventListener("submit", (e) => {
          e.preventDefault();
          const message = messageInput.value.trim();
          const file = fileInput.files[0];

          if (!message && !file) {
            return;
          }

          const payload = {
            project_id: projectId,
            message: message,
          };

          if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
              payload.file = event.target.result;
              payload.filename = file.name;
              socket.emit("new_message", payload);
              messageInput.value = "";
              fileInput.value = null;
            };
            reader.readAsDataURL(file);
          } else {
            socket.emit("new_message", payload);
            messageInput.value = "";
          }
        });
      });
    </script>
  {% endif %}
{% endblock %}
