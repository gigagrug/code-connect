{% extends "./layouts/shell.html" %}

{% block head %}
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
{% endblock %}

{% block content %}
  <div class="container mx-auto px-4 py-12">
    <div class="grid grid-cols-1 gap-8 lg:grid-cols-3">
      <div class="lg:col-span-2">
        <div class="mx-auto w-full overflow-hidden rounded-lg border border-neutral-200 bg-white shadow-sm dark:border-neutral-700 dark:bg-neutral-800">
          <div class="p-8 md:p-12">
            <h1 class="mb-2 text-4xl font-extrabold md:text-5xl">Application for: {{ application.job_title }}</h1>
            <p class="text-lg text-gray-500 dark:text-gray-400">From: <strong class="text-gray-700 dark:text-gray-300">{{ application.applicant_name or application.applicant_email }}</strong></p>

            <div class="mt-6 space-y-4 border-t pt-6 dark:border-gray-700">
              {% if application.resume_path %}
                <a href="{{ application.resume_path }}" target="_blank" class="btn-primary">View Resume</a>
              {% else %}
                <p class="text-gray-500 italic">No resume provided.</p>
              {% endif %}

              {% if application.cover_letter_path %}
                <a href="{{ application.cover_letter_path }}" target="_blank" class="btn-secondary">View Cover Letter</a>
              {% else %}
                <p class="text-gray-500 italic">No cover letter provided.</p>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <div class="lg:col-span-1">
        <div class="flex h-[70vh] flex-col rounded-lg border border-neutral-200 bg-white p-4 shadow-sm dark:border-neutral-700 dark:bg-neutral-800">
          <h3 class="mb-4 border-b pb-2 text-center text-xl font-semibold dark:border-gray-600">Application Chat</h3>
          <div id="chat-messages" class="flex-grow space-y-4 overflow-y-auto pr-2">
            {% for msg in chat_history %}
              <div id="message-{{ msg.message_id }}" class="{% if msg.email == session.email %}items-end{% else %}items-start{% endif %} flex flex-col">
                <div class="flex items-center gap-2">
                  {% if msg.email == session.email %}
                    <button class="delete-btn text-xs text-gray-400 hover:text-red-500" data-message-id="{{ msg.message_id }}">&times;</button>
                  {% endif %}
                  <div class="text-xs text-gray-500 dark:text-gray-400">{{ msg.email }} <span class="ml-2 text-gray-400">{{ msg.timestamp.strftime("%b %d, %I:%M %p") }}</span></div>
                </div>
                <div class="message-body {% if msg.email == session.email %}bg-blue-600 text-white{% else %}bg-gray-100 dark:bg-gray-700{% endif %} max-w-xs rounded-lg p-2 break-words">{{ msg.message_ }}</div>
              </div>
            {% endfor %}
          </div>
          <div class="mt-4 border-t pt-4 dark:border-gray-600">
            <form id="chat-form" class="flex items-center gap-2">
              <input type="text" id="message-input" placeholder="Type a message..." class="w-full rounded-lg border border-neutral-300 p-2 placeholder:text-neutral-500 dark:border-neutral-700" autocomplete="off" required />
              <button type="submit" class="flex-shrink-0 rounded-lg bg-blue-600 p-2 text-white">Send</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const applicationId = "{{ application.id }}";
      const currentUserEmail = "{{ session.email }}";
      const messagesContainer = document.getElementById("chat-messages");
      const chatForm = document.getElementById("chat-form");
      const messageInput = document.getElementById("message-input");
      const socket = io();

      if (messagesContainer) {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      // 1. Join the correct room
      socket.on("connect", () => socket.emit("join_application_room", { application_id: applicationId }));

      // 2. Listen for new messages
      socket.on("application_message_broadcast", (data) => {
        const isCurrentUser = data.email === currentUserEmail;
        const msgContainer = document.createElement("div");
        msgContainer.id = `message-${data.message_id}`;
        msgContainer.className = `flex flex-col ${isCurrentUser ? "items-end" : "items-start"}`;

        let deleteBtnHtml = isCurrentUser ? `<button class="delete-btn text-xs text-gray-400 hover:text-red-500" data-message-id="${data.message_id}">&times;</button>` : "";

        const infoDiv = document.createElement("div");
        infoDiv.className = "flex items-center gap-2";
        infoDiv.innerHTML = `${deleteBtnHtml}<div class="text-xs text-gray-500 dark:text-gray-400">${data.email} <span class="ml-2 text-gray-400">${data.timestamp}</span></div>`;

        const messageBody = document.createElement("div");
        messageBody.className = `message-body rounded-lg p-2 max-w-xs break-words ${isCurrentUser ? "bg-blue-600 text-white" : "bg-gray-100 dark:bg-gray-700"}`;
        messageBody.textContent = data.message;
        // (Add attachment logic here if needed)

        msgContainer.appendChild(infoDiv);
        msgContainer.appendChild(messageBody);
        messagesContainer.appendChild(msgContainer);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      });

      // 3. Listen for deleted messages
      socket.on("application_message_deleted", (data) => {
        const msgElement = document.getElementById(`message-${data.message_id}`);
        if (msgElement) {
          msgElement.remove();
        }
      });

      // 4. Add delete click listener
      messagesContainer.addEventListener("click", (e) => {
        if (e.target.classList.contains("delete-btn")) {
          const messageId = e.target.dataset.messageId;
          if (confirm("Are you sure you want to delete this message?")) {
            socket.emit("delete_application_message", { message_id: messageId });
          }
        }
      });

      // 5. Send a new message
      chatForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const message = messageInput.value.trim();
        if (message) {
          socket.emit("new_application_message", { application_id: applicationId, message: message });
          messageInput.value = "";
        }
      });
    });
  </script>
{% endblock %}
