{% extends "./layouts/shell.html" %}

{% block content %}
  <div class="container mx-auto px-4 py-8">
    <h2 class="mb-6 text-center text-3xl font-bold">Explore All Projects</h2>

    <div class="overflow-hidden rounded-lg border border-neutral-200 bg-white shadow-sm dark:border-neutral-700 dark:bg-neutral-800">
      <table class="w-full text-left text-sm">
        <thead class="bg-neutral-50 text-xs text-neutral-700 uppercase dark:bg-neutral-700 dark:text-neutral-400">
          <tr>
            <th scope="col" class="px-6 py-3">Status</th>
            <th scope="col" class="px-6 py-3">Project Name</th>
            <th scope="col" class="px-6 py-3">Description</th>
            <th scope="col" class="px-6 py-3">Created By</th>
          </tr>
        </thead>
        <tbody id="projects-grid" class="divide-y divide-gray-200 dark:divide-gray-700">
          {% for project in projects %}
            {% include "partials/project_card.html" %}
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div id="loader" class="py-8 text-center text-2xl" style="display: none;">Loading...</div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const projectsGrid = document.getElementById("projects-grid");
      const loader = document.getElementById("loader");
      let currentPage = 1;
      let isLoading = false;
      let noMoreProjects = false;

      const loadMoreProjects = async () => {
        if (isLoading || noMoreProjects) return;

        isLoading = true;
        loader.style.display = "block";
        currentPage++;

        try {
          const response = await fetch(`/api/load-projects?page=${currentPage}`);
          const newProjectsHtml = await response.text();

          if (newProjectsHtml.trim() === "") {
            noMoreProjects = true;
            loader.innerHTML = "You've reached the end!";
            return;
          }

          projectsGrid.insertAdjacentHTML("beforeend", newProjectsHtml);
        } catch (error) {
          console.error("Failed to load more projects:", error);
          loader.innerHTML = "Failed to load projects.";
        } finally {
          isLoading = false;
          if (!noMoreProjects) {
            loader.style.display = "none";
          }
        }
      };

      const checkAndLoadInitial = async () => {
        while (window.innerHeight >= document.body.offsetHeight && !noMoreProjects) {
          await loadMoreProjects();
        }
      };

      window.addEventListener("scroll", () => {
        if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 100) {
          loadMoreProjects();
        }
      });

      checkAndLoadInitial();
    });
  </script>
{% endblock %}
