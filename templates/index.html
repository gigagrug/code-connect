{% extends "./layouts/shell.html" %}

{% block content %}
  <div class="container mx-auto max-w-7xl px-4 py-8">
    <h2 class="mb-8 text-center text-3xl font-bold text-neutral-900 dark:text-white">Explore All Projects</h2>

    <div class="overflow-hidden rounded-xl border border-neutral-200 bg-white shadow-sm dark:border-neutral-800 dark:bg-neutral-900">
      <table class="w-full text-left">
        <thead class="bg-neutral-50 border-b border-neutral-200 dark:bg-neutral-800/50 dark:border-neutral-800">
          <tr>
            <th scope="col" class="px-6 py-4 text-xs font-bold uppercase tracking-wider text-neutral-500 dark:text-neutral-400">Status</th>
            <th scope="col" class="px-6 py-4 text-xs font-bold uppercase tracking-wider text-neutral-500 dark:text-neutral-400">Project Name</th>
            <th scope="col" class="px-6 py-4 text-xs font-bold uppercase tracking-wider text-neutral-500 dark:text-neutral-400">Description</th>
            <th scope="col" class="px-6 py-4 text-xs font-bold uppercase tracking-wider text-neutral-500 dark:text-neutral-400">Created By</th>
          </tr>
        </thead>
        <tbody id="projects-grid" class="divide-y divide-neutral-200 dark:divide-neutral-800">
          {% for project in projects %}
            {% include "partials/project_card.html" %}
          {% endfor %}
        </tbody>
      </table>
    </div>
    
    <div id="loader" class="py-8 text-center text-neutral-500 dark:text-neutral-400" style="display: none;">
        <div class="flex flex-col items-center justify-center gap-2">
            <i data-lucide="loader-2" class="h-6 w-6 animate-spin"></i>
            <span class="text-sm font-medium">Loading more projects...</span>
        </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const projectsGrid = document.getElementById("projects-grid");
      const loader = document.getElementById("loader");
      let currentPage = 1;
      let isLoading = false;
      let noMoreProjects = false;

      const loadMoreProjects = async () => {
        if (isLoading || noMoreProjects) return;

        isLoading = true;
        loader.style.display = "block";
        currentPage++;

        try {
          const response = await fetch(`/api/load-projects?page=${currentPage}`);
          const newProjectsHtml = await response.text();

          if (newProjectsHtml.trim() === "") {
            noMoreProjects = true;
            loader.innerHTML = '<span class="text-sm font-medium">You\'ve reached the end!</span>';
            return;
          }

          projectsGrid.insertAdjacentHTML("beforeend", newProjectsHtml);
          // Re-initialize icons for newly added content
          if (window.lucide) window.lucide.createIcons();
        } catch (error) {
          console.error("Failed to load more projects:", error);
          loader.innerHTML = '<span class="text-sm font-medium text-red-500">Failed to load projects.</span>';
        } finally {
          isLoading = false;
          if (!noMoreProjects) {
            loader.style.display = "none";
          }
        }
      };

      const checkAndLoadInitial = async () => {
        while (window.innerHeight >= document.body.offsetHeight && !noMoreProjects) {
          await loadMoreProjects();
        }
      };

      window.addEventListener("scroll", () => {
        if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 100) {
          loadMoreProjects();
        }
      });

      checkAndLoadInitial();
    });
  </script>
{% endblock %}
